<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Local AI · RedNote Rewriter</title>
  <style>
    :root{--bg:#f5efe6;--card:#fffaf2;--muted:#8b7e6a;--text:#3a2f24;--accent:#c86a3a;--border:#eadfce; --slide-bg: #fff; --slide-text: #000;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px}
    .card{background:var(--card);border-radius:16px;padding:14px;border:1px solid var(--border);box-shadow:0 10px 24px rgba(120,90,60,.12)}
    
    /* Layout */
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    .flex-spacer{flex:1}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    /* Controls */
    button{background:var(--accent);border:0;border-radius:12px;color:white;padding:10px 14px;font-weight:600;cursor:pointer;white-space:nowrap}
    button.secondary{background:#e8d6c6;color:#4b3a2c}
    button:disabled{opacity:.5;cursor:not-allowed}
    select, input[type="text"], input[type="number"], input[type="color"]{border:1px solid var(--border);border-radius:8px;padding:6px;background:#fffdf7; font-size:13px}
    .checkbox-label{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;user-select:none}
    label{font-size:12px;color:var(--muted);margin-bottom:2px;display:block}
    
    textarea{
        width: 100%;
        min-height: 200px;
        box-sizing: border-box;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-family: inherit;
        resize: vertical;
        background: #fffdf7;
        margin-bottom: 12px;
    }
    
    /* Slide Preview Area */
    .preview-area{
        overflow-x: auto;
        white-space: nowrap;
        padding: 10px 0;
        display: flex;
        gap: 16px;
        min-height: 480px;
        align-items: start;
        scrollbar-width: thin;
        scrollbar-color: var(--accent) var(--border);
    }
    .preview-area::-webkit-scrollbar { height: 8px; }
    .preview-area::-webkit-scrollbar-track { background: var(--border); border-radius: 4px; }
    .preview-area::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }

    /* Individual Slide */
    .slide-wrapper{display:inline-flex;flex-direction:column;gap:8px;vertical-align:top}
    .slide{
        width: 320px; /* Wider for better preview */
        aspect-ratio: 3/4;
        background: var(--slide-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        white-space: normal;
        display: flex;
        flex-direction: column;
        color: var(--slide-text);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        background-size: cover;
        background-position: center;
        transition: transform 0.2s;
    }
    .slide:hover{transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.15);}
    
    /* Inline Toolbar */
    .inline-toolbar {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 4px;
        display: flex;
        gap: 4px;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        flex-wrap: wrap;
        max-width: 220px;
    }
    .inline-toolbar button {
        padding: 4px 8px;
        font-size: 12px;
        background: transparent;
        color: var(--text);
        border-radius: 4px;
        border: 1px solid transparent;
        cursor: pointer;
    }
    .inline-toolbar button:hover {
        background: var(--bg);
        border-color: var(--border);
    }
    .color-swatch {
        width: 16px; height: 16px; border-radius: 50%; display: inline-block; vertical-align: middle;
        border: 1px solid #d9d9d9;
    }
    
    /* Watermark */
    .watermark {
        position: absolute; pointer-events: none;
        white-space: nowrap; font-weight: bold;
        z-index: 5;
        transform-origin: center;
    }
    
    /* Footnote */
    .footnote {
        position: absolute; z-index: 10;
        bottom: 0; left: 0; right: 0;
        padding: 8px 12px;
        font-size: 13px; opacity: 0.8;
        pointer-events: none;
    }
    
    /* Badge */
    .slide-badge {
        position: absolute; z-index: 10;
        padding: 4px 8px; border-radius: 4px;
        font-size: 10px; font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        pointer-events: none;
    }
    .slide-badge.tl { top: 12px; left: 12px; }
    .slide-badge.tr { top: 12px; right: 12px; }

    /* Slide Content Layers */
    .slide-bg{position:absolute;inset:0;z-index:0;background-size:cover;background-position:center;}
    .slide-overlay{position:absolute;inset:0;z-index:1;} /* Optional tint */
    .slide-content{
        position:relative;z-index:2;
        padding: 24px;
        flex:1;
        display:flex;
        flex-direction:column;
        overflow-y: hidden;
    }

    /* Typography inside slides */
    .slide-title{font-weight: 800; line-height: 1.3;}
    .slide-text{font-size: 18px; line-height: 1.6; font-weight: 500;}
    .slide-text ul { padding-left: 20px; margin: 0; }
    .slide-text li { margin-bottom: 8px; }
    .slide-text p { margin-bottom: 12px; }

    /* Cover Page Specifics */
    .slide.cover .slide-title { text-align: center; position: absolute; }
    
    /* Ending Page Specifics */
    .slide.ending .slide-content { padding: 0; }
    .ending-mask {
        position: absolute; inset: 0; z-index: 10;
        /* dynamic background set via JS */
        display: flex; align-items: flex-end; justify-content: center;
        padding-bottom: 60px;
    }
    .cta-box {
        color: white; text-align: center;
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(4px);
        padding: 8px 16px; border-radius: 99px;
        border: 1px solid rgba(255,255,255,0.4);
        font-size: 14px; font-weight: bold;
        position: absolute;
        /* Dynamic bottom position based on circle */
    }
    .circle-highlight {
        position: absolute; left: 50%; transform: translate(-50%, -50%);
        border-radius: 50%;
        pointer-events: none;
        /* Dynamic top/size */
    }

    /* Utilities */
    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none !important}
    .warning{color:#c83a3a;font-size:11px}
    .rel{position:relative}
    .control-group{border:1px solid var(--border); padding:8px; border-radius:8px; background:rgba(255,255,255,0.5)}
    .control-title{font-size:11px; font-weight:bold; color:var(--accent); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px}

    /* Global Overlay (Loading) */
    .overlay{position:absolute;inset:0;background:rgba(255,250,242,.9);border-radius:12px;display:flex;align-items:center;justify-content:center;gap:10px;flex-direction:column;z-index:20}
    .bar{height:8px;background:#efe4d6;border-radius:999px;overflow:hidden;border:1px solid var(--border);width:200px}
    .bar>div{height:100%;width:0;background:linear-gradient(90deg,#e3b18f,#c86a3a)}

    /* File Input Styling */
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%;}
  </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  </head>
<body>
  <div class="wrap">
    <h1>RedNote Writer (Local AI)</h1>
    
    <!-- Top Controls: Global Settings & Customizations -->
    <div class="card" style="margin-bottom: 12px;">
      <div class="row" style="align-items:stretch">
        
        <!-- Images -->
        <div class="control-group col">
            <div class="control-title">Images</div>
            <div class="row">
                <div class="file-input-wrapper"><button class="secondary" style="font-size:12px">Up Cover</button><input type="file" id="coverUpload" accept="image/*"></div>
                <div class="file-input-wrapper"><button class="secondary" style="font-size:12px">Up Content</button><input type="file" id="bgUpload" accept="image/*"></div>
                <div class="file-input-wrapper"><button class="secondary" style="font-size:12px">Up End</button><input type="file" id="endUpload" accept="image/*"></div>
                <button id="resetImgs" class="secondary" style="font-size:12px">Reset</button>
            </div>
        </div>

        <!-- Cover Customization -->
        <div class="control-group col" style="flex:1">
            <div class="control-title">Cover Style</div>
            <div class="row">
                <div class="col" style="gap:4px">
                    <label>Title</label>
                    <input type="text" id="coverTitleInput" placeholder="Title..." style="width:80px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Font</label>
                    <select id="coverFontSelect" style="width:90px">
                        <option value="sans-serif">Sans Serif</option>
                        <option value="'PingFang SC', sans-serif">PingFang</option>
                        <option value="'Noto Sans CJK SC', sans-serif">Noto Sans</option>
                        <option value="'Songti SC', serif">Songti</option>
                        <option value="'Kaiti SC', cursive">Kaiti</option>
                    </select>
                </div>
                <div class="col" style="gap:4px">
                    <label>Size</label>
                    <input type="number" id="coverSize" value="36" style="width:40px">
                </div>
                <div class="col" style="gap:4px">
                    <label>X %</label>
                    <input type="number" id="coverX" value="50" style="width:40px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Y %</label>
                    <input type="number" id="coverY" value="50" style="width:40px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Rot °</label>
                    <input type="number" id="coverRot" value="0" style="width:40px">
                </div>
                 <div class="col" style="gap:4px">
                    <label>Color</label>
                    <input type="color" id="coverColor" value="#000000" style="width:30px;height:30px;padding:0;border:0">
                </div>
            </div>
        </div>

      </div>
      
      <div style="height:8px"></div>
      
      <div class="row" style="align-items:stretch">
        <!-- Content Page Customization -->
        <div class="control-group col" style="flex:1">
             <div class="control-title">Content Style</div>
             <div class="row">
                <div class="col" style="gap:4px">
                    <label>Pad</label>
                    <input type="number" id="contentPad" value="24" style="width:40px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Pad Color</label>
                    <input type="color" id="contentPadColor" value="#ffffff" style="width:30px;height:30px;padding:0;border:0">
                </div>
                <div class="col" style="gap:4px">
                    <label>Pad Opacity</label>
                    <input type="number" id="contentPadOp" value="0.8" min="0" max="1" step="0.1" style="width:40px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Text Color</label>
                    <input type="color" id="contentColor" value="#000000" style="width:30px;height:30px;padding:0;border:0">
                </div>
                <div class="col" style="gap:4px">
                    <label>Font</label>
                    <select id="contentFontSelect" style="width:90px">
                        <option value="sans-serif">Sans Serif</option>
                        <option value="'PingFang SC', sans-serif">PingFang</option>
                        <option value="'Songti SC', serif">Songti</option>
                    </select>
                </div>
             </div>
        </div>

        <!-- Ending Page Customization -->
        <div class="control-group col" style="flex:1">
             <div class="control-title">Ending Style</div>
             <div class="row">
                <div class="col" style="gap:4px">
                    <label>Circle Size</label>
                    <input type="number" id="endCircleSize" value="160" style="width:50px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Circle Y%</label>
                    <input type="number" id="endCircleY" value="50" style="width:50px">
                </div>
             </div>
        </div>
      </div>

    </div>
    
    <!-- Decorations: Badge, Watermark, Footnote -->
    <div class="card" style="margin-bottom: 12px;">
         <div class="row" style="align-items:stretch">
             
             <!-- Badge -->
            <div class="control-group col" style="flex:1">
                <div class="control-title">Badge (Global)</div>
                <div class="row">
                    <div class="col" style="gap:4px">
                       <label>Text</label>
                       <input type="text" id="badgeText" placeholder="New" style="width:50px">
                    </div>
                    <div class="col" style="gap:4px">
                       <label>Bg Color</label>
                       <input type="color" id="badgeColor" value="#ff4d4f" style="width:30px;height:30px;padding:0;border:0">
                    </div>
                    <div class="col" style="gap:4px">
                       <label>Pos</label>
                       <select id="badgePos" style="width:50px">
                           <option value="tl">TL</option>
                           <option value="tr">TR</option>
                       </select>
                    </div>
                    <div class="col" style="gap:4px">
                       <label>Rot</label>
                       <input type="number" id="badgeRot" value="0" style="width:40px">
                    </div>
                </div>
            </div>

             <!-- Watermark -->
             <div class="control-group col" style="flex:1">
                 <div class="control-title">Watermark</div>
                 <div class="row">
                     <div class="col" style="gap:4px">
                        <label>Text</label>
                        <input type="text" id="wmText" placeholder="None" style="width:60px">
                     </div>
                     <div class="col" style="gap:4px">
                        <label>Op</label>
                        <input type="number" id="wmOp" value="0.1" step="0.1" min="0" max="1" style="width:40px">
                     </div>
                     <div class="col" style="gap:4px">
                        <label>Rot</label>
                        <input type="number" id="wmRot" value="-30" style="width:40px">
                     </div>
                     <div class="col" style="gap:4px">
                        <label>Color</label>
                        <input type="color" id="wmColor" value="#000000" style="width:30px;height:30px;padding:0;border:0">
                     </div>
                 </div>
             </div>

             <!-- Footnote -->
             <div class="control-group col" style="flex:1">
                 <div class="control-title">Footnote</div>
                 <div class="row">
                     <div class="col" style="gap:4px">
                        <label>Text</label>
                        <input type="text" id="fnText" placeholder="@author" style="width:70px">
                     </div>
                     <div class="col" style="gap:4px">
                        <label>X %</label>
                        <input type="number" id="fnX" value="50" style="width:40px">
                     </div>
                     <div class="col" style="gap:4px">
                        <label>Bot px</label>
                        <input type="number" id="fnBot" value="20" style="width:40px">
                     </div>
                      <div class="col" style="gap:4px">
                        <label>Color</label>
                        <input type="color" id="fnColor" value="#888888" style="width:30px;height:30px;padding:0;border:0">
                     </div>
                 </div>
             </div>
             
         </div>
    </div>

    <!-- Output Preview (Slides) -->
    <div class="card rel" style="min-height: 480px;">
        <div style="position:absolute; top:14px; right:14px; z-index:100">
             <button id="downloadAllBtn" class="secondary" style="font-size:12px">Download All</button>
        </div>
      <div class="preview-area" id="slideContainer">
        <!-- Slides will be injected here -->
        <div class="muted" style="margin:auto">Generated slides will appear here...</div>
      </div>

      <!-- Loading Overlay -->
      <div class="overlay" id="overlay">
        <div class="status" id="status">Initializing...</div>
        <div class="bar"><div id="progress"></div></div>
        <div class="muted" id="statusDetail"></div>
      </div>
    </div>

    <div style="height:12px"></div>

    <!-- Input Section -->
    <div class="card">
      <textarea id="input" placeholder="Paste content here..."></textarea>
      
      <div class="row">
        <button id="run" disabled>Rewrite</button>
        
        <label class="checkbox-label hidden">
          <input type="checkbox" id="realtimeToggle"> 
          Real-time
        </label>
        <span class="warning hidden" id="rtWarning">High CPU</span>

        <div class="flex-spacer"></div>

        <span class="badge" id="modelTag">Model: Not Ready</span>
        <select id="modelSelect">
          <option value="small">Small</option>
          <option value="large">Large</option>
        </select>
        <button class="secondary hidden" id="loadLargeBtn">Load Large</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { CreateMLCEngine } from 'https://esm.run/@mlc-ai/web-llm';

    const $ = (id)=>document.getElementById(id);
    const input = $('input');
    const slideContainer = $('slideContainer');
    const status = $('status');
    const statusDetail = $('statusDetail');
    const runBtn = $('run');
    const modelTag = $('modelTag');
    const progress = $('progress');
    const overlay = $('overlay');
    const modelSelect = $('modelSelect');
    const loadLargeBtn = $('loadLargeBtn');
    const realtimeToggle = $('realtimeToggle');
    const rtWarning = $('rtWarning');
    
    // UI Controls
    const coverUpload = $('coverUpload');
    const bgUpload = $('bgUpload');
    const endUpload = $('endUpload');
    const resetImgs = $('resetImgs');
    
    // Cover Controls
    const coverTitleInput = $('coverTitleInput');
    const coverFontSelect = $('coverFontSelect');
    const coverSize = $('coverSize');
    const coverX = $('coverX');
    const coverY = $('coverY');
    const coverRot = $('coverRot');
    const coverColor = $('coverColor');

    // Content Controls
    const contentPad = $('contentPad');
    const contentPadColor = $('contentPadColor');
    const contentPadOp = $('contentPadOp');
    const contentColor = $('contentColor');
    const contentFontSelect = $('contentFontSelect');

    // Ending Controls
    const endCircleSize = $('endCircleSize');
    const endCircleY = $('endCircleY');
    
    // Download Control
    const downloadAllBtn = $('downloadAllBtn');

    // Decoration Controls
    const badgeText = $('badgeText');
    const badgeColor = $('badgeColor');
    const badgePos = $('badgePos');
    const badgeRot = $('badgeRot');
    const wmText = $('wmText');
    const wmOp = $('wmOp');
    const wmRot = $('wmRot');
    const wmColor = $('wmColor');
    const fnText = $('fnText');
    const fnX = $('fnX');
    const fnBot = $('fnBot');
    const fnColor = $('fnColor');

    // State
    const defaultState = {
        coverImg: null,
        contentBg: null,
        endImg: null,
        coverTitle: 'RedNote Title',
        coverFont: 'sans-serif',
        coverSize: 36,
        coverX: 50,
        coverY: 50,
        coverRot: 0,
        coverColor: '#000000',
        
        contentPad: 24,
        contentPadColor: '#ffffff',
        contentPadOp: 0.8,
        contentColor: '#000000',
        contentFont: 'sans-serif',

        endCircleSize: 160,
        endCircleY: 50,

        // Decorations
        badgeText: 'NEW',
        badgeColor: '#ff4d4f',
        badgePos: 'tr',
        badgeRot: 0,
        
        wmText: '',
        wmOp: 0.1,
        wmRot: -30,
        wmColor: '#000000',
        
        fnText: '',
        fnX: 50,
        fnBot: 20,
        fnColor: '#888888',
        
        slideConfigs: {}, // index -> { showBadge: bool }

        generatedText: '',
        slides: [] 
    };

    // Load from LocalStorage
    let savedState = {};
    try {
        const saved = localStorage.getItem('rednoteState');
        if(saved) savedState = JSON.parse(saved);
    } catch(e){ console.error(e); }

    const state = { ...defaultState, ...savedState };
    
    // Restore Input
    if(localStorage.getItem('rednoteInput')) {
        input.value = localStorage.getItem('rednoteInput');
    }

    // Save State Helper
    function saveState(){
        localStorage.setItem('rednoteState', JSON.stringify(state));
    }
    
    // Save Input Helper
    input.addEventListener('input', ()=>{
        localStorage.setItem('rednoteInput', input.value);
    });

    // --- Helper for Download ---
    async function downloadSlide(element, filename) {
        if(!element) return;
        try {
            const canvas = await html2canvas(element, {
                scale: 2, // Retina quality
                useCORS: true,
                backgroundColor: null // Transparent if needed, but slides have bg
            });
            // Trigger download
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL("image/png");
            link.click();
        } catch(e) {
            console.error('Download failed:', e);
            alert('Download failed. Check console.');
        }
    }

    // Download All
    if(downloadAllBtn){
        downloadAllBtn.addEventListener('click', async () => {
             downloadAllBtn.textContent = 'Generating...';
             downloadAllBtn.disabled = true;
             
             try {
                 const zip = new JSZip();
                 const slides = slideContainer.querySelectorAll('.slide');
                 
                 // Process sequentially to avoid freezing browser too much
                 for(let i=0; i<slides.length; i++){
                     const s = slides[i];
                     const name = `slide_${i+1}.png`;
                     const canvas = await html2canvas(s, { scale: 2, useCORS: true });
                     const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                     zip.file(name, blob);
                 }
                 
                 const content = await zip.generateAsync({type:"blob"});
                 saveAs(content, "slides_pack.zip"); // FileSaver.js
                 
             } catch(e) {
                 console.error(e);
                 alert('Batch download failed');
             } finally {
                 downloadAllBtn.textContent = 'Download All';
                 downloadAllBtn.disabled = false;
             }
        });
    }

    // Models
    const SMALL_MODEL = 'Qwen2-0.5B-Instruct-q4f16_1-MLC';
    const LARGE_MODEL = 'Phi-3.5-mini-instruct-q4f16_1-MLC';
    let engine;
    let currentModelId = SMALL_MODEL;
    let isSmallLoaded = false;
    let isLargeLoaded = false;
    let isGenerating = false;
    let debounceTimer = null;
    let lastRunTime = 0;

    // --- UI Listeners ---

    function bind(el, key, type='value'){
        // Set initial value from state
        if(type === 'value') el.value = state[key];
        else if(type === 'number') el.value = state[key];
        // Special handling for some inputs if needed?
        
        el.addEventListener('input', (e)=>{
            state[key] = type==='number'? parseFloat(e.target.value) : e.target.value;
            saveState();
            renderSlides();
        });
    }
    
    // Bind all controls
    bind(coverTitleInput, 'coverTitle');
    bind(coverFontSelect, 'coverFont');
    bind(coverSize, 'coverSize', 'number');
    bind(coverX, 'coverX', 'number');
    bind(coverY, 'coverY', 'number');
    bind(coverRot, 'coverRot', 'number');
    bind(coverColor, 'coverColor');
    
    bind(contentPad, 'contentPad', 'number');
    bind(contentPadColor, 'contentPadColor');
    bind(contentPadOp, 'contentPadOp', 'number');
    bind(contentColor, 'contentColor');
    bind(contentFontSelect, 'contentFont');

    bind(endCircleSize, 'endCircleSize', 'number');
    bind(endCircleY, 'endCircleY', 'number');

    // Decoration Binds
    bind(badgeText, 'badgeText');
    bind(badgeColor, 'badgeColor');
    bind(badgePos, 'badgePos');
    bind(badgeRot, 'badgeRot', 'number');
    bind(wmText, 'wmText');
    bind(wmOp, 'wmOp', 'number');
    bind(wmRot, 'wmRot', 'number');
    bind(wmColor, 'wmColor');
    bind(fnText, 'fnText');
    bind(fnX, 'fnX', 'number');
    bind(fnBot, 'fnBot', 'number');
    bind(fnColor, 'fnColor');

    // Image Handling
    function handleImageUpload(e, key){
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            state[key] = evt.target.result;
            saveState();
            renderSlides();
        };
        reader.readAsDataURL(file);
    }
    coverUpload.addEventListener('change', (e)=>handleImageUpload(e, 'coverImg'));
    bgUpload.addEventListener('change', (e)=>handleImageUpload(e, 'contentBg'));
    endUpload.addEventListener('change', (e)=>handleImageUpload(e, 'endImg'));
    
    resetImgs.addEventListener('click', ()=>{
        state.coverImg = null;
        state.contentBg = null;
        state.endImg = null;
        saveState();
        renderSlides();
    });

    // --- Slide Rendering ---
    
    function renderSlides(){
        slideContainer.innerHTML = '';
        
        // 1. Cover Slide
        const coverWrapper = createSlideWrapper('Cover', -1, true);
        const coverSlide = createSlideElement();
        if(state.coverImg) setSlideBg(coverSlide, state.coverImg);
        else coverSlide.style.background = '#e8d6c6';
        
        const coverContent = document.createElement('div');
        coverContent.className = 'slide-content';
        
        // Dynamic Title
        const titleEl = document.createElement('div');
        titleEl.className = 'slide-title';
        titleEl.style.fontFamily = state.coverFont;
        titleEl.textContent = state.coverTitle;
        titleEl.style.fontSize = `${state.coverSize}px`;
        titleEl.style.color = state.coverColor;
        titleEl.style.position = 'absolute';
        titleEl.style.left = `${state.coverX}%`;
        titleEl.style.top = `${state.coverY}%`;
        titleEl.style.transform = `translate(-50%, -50%) rotate(${state.coverRot}deg)`;
        titleEl.style.width = '100%'; // Ensure centering works relative to slide width
        titleEl.style.textAlign = 'center';
        titleEl.style.pointerEvents = 'none'; // Click through

        coverContent.appendChild(titleEl);
        coverSlide.appendChild(coverContent);
        coverWrapper.appendChild(coverSlide);
        slideContainer.appendChild(coverWrapper);

        // 2. Content Slides
        const chunks = state.slides.length ? state.slides : (state.generatedText ? splitContentToSlides(state.generatedText) : []);
        // Force at least one empty slide if nothing exists
        const renderChunks = chunks.length ? chunks : [];

        renderChunks.forEach((text, idx) => {
            const wrapper = createSlideWrapper(`Page ${idx+1}`, idx, true);
            const slide = createSlideElement();
            if(state.contentBg) setSlideBg(slide, state.contentBg);
            
            // Watermark (Global)
            if(state.wmText){
                const wm = document.createElement('div');
                wm.className = 'watermark';
                wm.textContent = state.wmText;
                wm.style.opacity = state.wmOp;
                wm.style.transform = `translate(-50%, -50%) rotate(${state.wmRot}deg)`;
                wm.style.color = state.wmColor;
                wm.style.fontSize = '24px';
                wm.style.left = '50%';
                wm.style.top = '50%';
                slide.appendChild(wm);
            }

            // Footnote (Global)
            if(state.fnText){
                const fn = document.createElement('div');
                fn.className = 'footnote';
                fn.textContent = state.fnText;
                fn.style.color = state.fnColor;
                fn.style.bottom = `${state.fnBot}px`;
                fn.style.left = `${state.fnX}%`;
                fn.style.transform = `translateX(-50%)`;
                slide.appendChild(fn);
            }

            // Badge (Per Slide Toggle)
            const config = state.slideConfigs[idx] || {};
            // Change: Badge is hidden by default (user requirement 1)
            // Logic: if config.showBadge === true then show.
            // Previous: config.showBadge !== false (default true)
            if(state.badgeText && config.showBadge === true){
                const badge = document.createElement('div');
                badge.className = `slide-badge ${state.badgePos}`;
                badge.textContent = state.badgeText;
                badge.style.backgroundColor = state.badgeColor;
                badge.style.color = '#fff';
                // Add Rotation
                badge.style.transform = `rotate(${state.badgeRot}deg)`;
                slide.appendChild(badge);
            }
            
            const content = document.createElement('div');
            content.className = 'slide-content';
            
            // Padding gap: Add 24px internal gap between border and text
            const innerGap = 24; 
            content.style.padding = `${state.contentPad + innerGap}px`;
            
            // Padding Background (Frame/Border effect)
            if(state.contentPadOp > 0){
                 const padBg = document.createElement('div');
                 padBg.style.position = 'absolute';
                 padBg.style.inset = '0'; // Cover entire slide
                 padBg.style.border = `${state.contentPad}px solid ${state.contentPadColor}`;
                 padBg.style.background = 'transparent'; // Center is clear
                 padBg.style.opacity = state.contentPadOp;
                 padBg.style.zIndex = 1; 
                 padBg.style.pointerEvents = 'none';
                 padBg.style.boxSizing = 'border-box';
                 slide.appendChild(padBg);
            }

            const textEl = document.createElement('div');
            textEl.className = 'slide-text';
            textEl.style.color = state.contentColor;
            textEl.style.fontFamily = state.contentFont;
            textEl.innerHTML = parseMarkdown(text); 
            // Make content editable
            textEl.contentEditable = true;
            textEl.style.outline = 'none'; // Clean look
            textEl.addEventListener('input', ()=>{
                // Update state when user edits slide content directly
                state.slides[idx] = textEl.innerText; 
                saveState();
            });
            // Show toolbar on focus?
            textEl.addEventListener('focus', () => showToolbar(textEl));
            textEl.addEventListener('blur', (e) => {
                 // Delay hiding to allow button clicks
                 setTimeout(()=>hideToolbar(), 200);
            });

            content.appendChild(textEl);
            slide.appendChild(content);
            wrapper.appendChild(slide);
            slideContainer.appendChild(wrapper);
        });

        // 3. Ending Slide
        const endWrapper = createSlideWrapper('Ending', -1, true);
        const endSlide = createSlideElement();
        endSlide.classList.add('ending');
        if(state.endImg) setSlideBg(endSlide, state.endImg);
        else endSlide.style.background = '#333';
        
        // Mask Overlay
        const mask = document.createElement('div');
        mask.className = 'ending-mask';
        
        // Calculate circle and mask
        const cy = 100 - state.endCircleY; 
        const r = state.endCircleSize / 2;
        
        mask.style.background = `radial-gradient(circle at 50% ${cy}%, transparent ${r}px, rgba(0,0,0,0.9) ${r+1}px)`;
        
        const circle = document.createElement('div');
        circle.className = 'circle-highlight';
        circle.style.width = `${state.endCircleSize}px`;
        circle.style.height = `${state.endCircleSize}px`;
        circle.style.top = `${cy}%`;

        const cta = document.createElement('div');
        cta.className = 'cta-box';
        cta.textContent = "Follow for more updates ✓";
        cta.style.position = 'absolute';
        cta.style.top = `calc(${cy}% + ${r}px + 20px)`;
        cta.style.left = '50%';
        cta.style.transform = 'translateX(-50%)';

        mask.appendChild(circle);
        mask.appendChild(cta);

        endSlide.appendChild(mask);
        endWrapper.appendChild(endSlide);
        slideContainer.appendChild(endWrapper);
    }

    function createSlideWrapper(label, idx = -1, allowDownload=false){
        const w = document.createElement('div');
        w.className = 'slide-wrapper';
        
        const header = document.createElement('div');
        header.className = 'row muted';
        header.style.justifyContent = 'space-between';
        header.style.fontSize = '12px';
        
        const leftGrp = document.createElement('div');
        leftGrp.style.display='flex'; leftGrp.style.gap='8px'; leftGrp.style.alignItems='center';
        
        const l = document.createElement('span');
        l.textContent = label;
        leftGrp.appendChild(l);
        
        // Download Button per slide
        if(allowDownload){
            const dlBtn = document.createElement('button');
            dlBtn.textContent = '⬇';
            dlBtn.style.padding = '2px 6px';
            dlBtn.style.fontSize = '10px';
            dlBtn.style.borderRadius = '4px';
            dlBtn.style.background = 'transparent';
            dlBtn.style.border = '1px solid var(--border)';
            dlBtn.style.color = 'var(--accent)';
            dlBtn.title = "Download this slide";
            dlBtn.onclick = () => {
                 const slideEl = w.querySelector('.slide');
                 downloadSlide(slideEl, `${label.replace(/\s+/g,'_')}.png`);
            };
            leftGrp.appendChild(dlBtn);
        }

        header.appendChild(leftGrp);

        // Add Badge Toggle for content slides
        if(idx >= 0 && state.badgeText){
            const labelEl = document.createElement('label');
            labelEl.className = 'checkbox-label';
            labelEl.style.margin = '0';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            // Default false (user requirement 1)
            const config = state.slideConfigs[idx] || {};
            cb.checked = config.showBadge === true; 
            
            cb.addEventListener('change', ()=>{
                 if(!state.slideConfigs[idx]) state.slideConfigs[idx] = {};
                 state.slideConfigs[idx].showBadge = cb.checked;
                 saveState();
                 renderSlides();
            });
            
            labelEl.appendChild(cb);
            labelEl.appendChild(document.createTextNode('Badge'));
            header.appendChild(labelEl);
        }

        w.appendChild(header);
        return w;
    }

    function createSlideElement(){
        const s = document.createElement('div');
        s.className = 'slide';
        return s;
    }

    function setSlideBg(el, src){
        const bg = document.createElement('div');
        bg.className = 'slide-bg';
        bg.style.backgroundImage = `url(${src})`;
        el.appendChild(bg);
        const ov = document.createElement('div');
        ov.className = 'slide-overlay';
        el.appendChild(ov);
    }

    function parseMarkdown(text){
        if(!text) return '';
        // Basic parser
        let html = text
            .replace(/^# (.*$)/gim, '<strong>$1</strong>')
            .replace(/^## (.*$)/gim, '<strong>$1</strong>')
            .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
            .replace(/\n/gim, '<br>');
        return html;
    }

    // --- Toolbar Logic ---
    let activeElement = null;
    const toolbar = document.createElement('div');
    toolbar.className = 'inline-toolbar hidden';
    
    // Define palette
    const colors = [
        '#000000', '#333333', '#888888', '#ffffff', 
        '#c86a3a', '#e05a47', '#ff4d4f', '#f5222d',
        '#faad14', '#52c41a', '#13c2c2', '#1890ff',
        '#2f54eb', '#722ed1', '#eb2f96'
    ];
    
    let colorBtns = colors.map(c => 
        `<button class="color-btn" data-color="${c}" title="${c}"><span class="color-swatch" style="background:${c}"></span></button>`
    ).join('');

    toolbar.innerHTML = `
        <div style="display:flex; gap:4px; margin-bottom:4px; width:100%; justify-content:center;">
            <button id="tb-bold" title="Bold" style="font-weight:bold">B</button>
            <button id="tb-bullet" title="Bullet List">• List</button>
            <button id="tb-small" title="Normal Size">Norm</button>
            <button id="tb-large" title="Large Size">Big</button>
            <button id="tb-color" title="Text Color" style="color:var(--accent)">Color ▾</button>
        </div>
        <div id="tb-palette" class="hidden" style="display:flex; gap:2px; flex-wrap:wrap; justify-content:center; padding-top:4px; border-top:1px solid var(--border)">
            ${colorBtns}
        </div>
    `;
    document.body.appendChild(toolbar);

    // Event Delegation for Toolbar
    toolbar.addEventListener('mousedown', (e) => {
        // Prevent losing focus from contentEditable
        e.preventDefault();
        const btn = e.target.closest('button');
        if(!btn) return;
        
        // Handle Color Buttons
        if(btn.classList.contains('color-btn')){
            const color = btn.dataset.color;
            document.execCommand('foreColor', false, color);
            // Hide palette after selection? Optional. User said "click button to appear", implied modal-ish.
            // Let's keep it open or close it? Close it feels cleaner.
            document.getElementById('tb-palette').classList.add('hidden');
            return;
        }

        const cmd = btn.id;
        if(cmd === 'tb-color') {
            document.getElementById('tb-palette').classList.toggle('hidden');
            return;
        }
        
        // Using document.execCommand for rich text editing
        if(cmd === 'tb-bold') document.execCommand('bold', false, null);
        if(cmd === 'tb-bullet') document.execCommand('insertUnorderedList', false, null);
        if(cmd === 'tb-small') document.execCommand('fontSize', false, '3'); // standard
        if(cmd === 'tb-large') document.execCommand('fontSize', false, '5'); // larger
    });

    function showToolbar(el){
        activeElement = el;
        const rect = el.getBoundingClientRect();
        // Calculate position relative to document
        const top = window.scrollY + rect.top - 40;
        const left = window.scrollX + rect.left + (rect.width/2);
        
        toolbar.style.top = `${top}px`;
        toolbar.style.left = `${left}px`;
        toolbar.style.transform = 'translateX(-50%)'; // Center horizontally
        toolbar.classList.remove('hidden');
        
        // Reset palette
        const pal = document.getElementById('tb-palette');
        if(pal) pal.classList.add('hidden');
    }

    function hideToolbar(){
        // Delay to allow click to register if moving focus
        setTimeout(() => {
            if(document.activeElement && document.activeElement.isContentEditable) return;
            toolbar.classList.add('hidden');
        }, 100);
    }

    // --- Content Splitting Logic ---
    function splitContentToSlides(fullText){
        if(!fullText) return [];
        
        // Improved splitting for mobile-focused slides (RedNote style)
        // Split by lines to ensure granular control
        const lines = fullText.split(/\n/);
        const slides = [];
        let current = "";
        const CHAR_LIMIT = 120; // Aggressive limit for big text/mobile view
        
        for(let line of lines){
            // If adding this line exceeds limit, push current and start new
            // But if current is empty, just take the line (even if huge)
            if(current.length > 0 && (current.length + line.length > CHAR_LIMIT)){
                 slides.push(current.trim());
                 current = line;
            } else {
                 // Preserve original spacing
                 current += (current ? "\n" : "") + line;
            }
        }
        if(current) slides.push(current.trim());
        
        return slides;
    }

    // --- Model Logic ---
    function setStatus(t, detail=''){ 
        status.textContent = t; 
        if(detail) statusDetail.textContent = detail;
    }
    function setProgress(p){ progress.style.width = Math.max(0,Math.min(100,Math.round(p*100)))+'%' }
    function showOverlay(show){ overlay.style.display = show ? 'flex' : 'none'; }

    async function loadModel(which){
      const targetModel = which === 'large' ? LARGE_MODEL : SMALL_MODEL;
      showOverlay(true);
      runBtn.disabled = true;
      setStatus(`Loading ${which}...`, 'Please wait...');
      setProgress(0);
      try{
        engine = await CreateMLCEngine(targetModel,{
          initProgressCallback:(p)=>{
            setStatus(`Loading... ${Math.round(p.progress*100)}%`, p.text||'');
            setProgress(p.progress);
          }
        });
        currentModelId = targetModel;
        if(which === 'small') isSmallLoaded = true;
        if(which === 'large') isLargeLoaded = true;
        modelTag.textContent = `Model: ${which === 'large' ? 'Large' : 'Small'}`;
        showOverlay(false);
        runBtn.disabled = false;
        updateControls();
      }catch(e){
        console.error(e);
        setStatus('Load Failed', e.message);
      }
    }

    function updateControls(){
        const selected = modelSelect.value;
        if(selected === 'large' && currentModelId !== LARGE_MODEL){
            loadLargeBtn.classList.remove('hidden');
            loadLargeBtn.textContent = isLargeLoaded ? "Switch to Large" : "Load Large";
            runBtn.disabled = true;
            modelTag.textContent = isLargeLoaded ? "Paused" : "Not Loaded";
        } else {
            loadLargeBtn.classList.add('hidden');
            if(selected === 'large'){
                runBtn.disabled = false;
                modelTag.textContent = "Model: Large";
            } else {
                if(currentModelId === SMALL_MODEL){
                    runBtn.disabled = false;
                    modelTag.textContent = "Model: Small";
                } else {
                     runBtn.disabled = true;
                }
            }
        }
    }

    modelSelect.addEventListener('change', async () => {
        if(modelSelect.value === 'large') updateControls(); 
        else {
            if(currentModelId !== SMALL_MODEL) await loadModel('small');
            updateControls();
        }
    });
    loadLargeBtn.addEventListener('click', () => loadModel('large'));

    // --- Realtime & Run ---
    // function triggerRealtime() {
    //     if(!realtimeToggle.checked) return;
    //     const now = Date.now();
    //     clearTimeout(debounceTimer);
    //     if(lastRunTime > 0 && (now - lastRunTime > 10000)){
    //          run();
    //     } else {
    //          debounceTimer = setTimeout(run, 3000);
    //     }
    // }

    // realtimeToggle.addEventListener('change', () => {
    //     const on = realtimeToggle.checked;
    //     rtWarning.classList.toggle('hidden', !on);
    //     if(!on) clearTimeout(debounceTimer);
    //     else if(input.value.trim()) triggerRealtime();
    // });
    // input.addEventListener('input', triggerRealtime);

    function buildPrompt(userText){
      const len = userText.length;
      const base = `You are a RedNote content editor. Task: "Format optimization or summary". Do not expand, fabricate, or add new info. Output in the same language as input. Layout: Subtitles ([] or #), short sentences, bullets (• or -), moderate emojis.`;
      if(len<40) return `${base}\nRule: Short text. Light formatting. ≤60 words.\n\nText:\n${userText}`;
      if(len>3000) return `${base}\nRule: Long text. Summarize to ≤200 words. Bullet points.\n\nText:\n${userText}`;
      return `${base}\nRule: Rewrite into clear short sentences. 2-4 sections. Add key points.\n\nText:\n${userText}`;
    }

    async function run(){
      if(isGenerating) return;
      const text = input.value.trim();
      if(!text) return;
      
      isGenerating = true;
      runBtn.disabled=true; 
      
      state.generatedText = '';
      state.slides = [];
      
      showOverlay(true);
      setStatus('Generating...');
      setProgress(1); 
      progress.parentElement.style.display = 'none';

      lastRunTime = Date.now();
      const messages=[{role:'system',content:'You are a high-quality social media content editor.'},{role:'user',content:buildPrompt(text)}];
      
      try{
        const stream=await engine.chat.completions.create({messages,temperature:0.4,stream:true,max_tokens:600});
        showOverlay(false);
        
        let fullAcc = "";
        for await(const chunk of stream){
          const token=chunk.choices?.[0]?.delta?.content||'';
          fullAcc += token;
          state.generatedText = fullAcc;
          // Live rendering every 50 chars to avoid flicker
          if(fullAcc.length % 50 === 0) {
             state.slides = splitContentToSlides(fullAcc);
             renderSlides();
          }
        }
        state.slides = splitContentToSlides(state.generatedText);
        renderSlides();
      }catch(e){ 
        console.error(e); 
        showOverlay(true);
        setStatus('Failed', e.message);
        setTimeout(()=>showOverlay(false), 3000);
      }finally{ 
        isGenerating = false;
        runBtn.disabled=false; 
        progress.parentElement.style.display = 'block'; 
        updateControls(); 
      }
    }

    runBtn.addEventListener('click',run);
    
    // Initial Render
    renderSlides();
    loadModel('small');
  </script>
</body>
</html>
