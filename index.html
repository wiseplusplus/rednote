<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Local AI · RedNote Rewriter</title>
  <style>
    :root{--bg:#f5efe6;--card:#fffaf2;--muted:#8b7e6a;--text:#3a2f24;--accent:#c86a3a;--border:#eadfce; --slide-bg: #fff; --slide-text: #000;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px}
    .card{background:var(--card);border-radius:16px;padding:14px;border:1px solid var(--border);box-shadow:0 10px 24px rgba(120,90,60,.12)}
    
    /* Layout */
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    .flex-spacer{flex:1}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    /* Controls */
    button{background:var(--accent);border:0;border-radius:12px;color:white;padding:10px 14px;font-weight:600;cursor:pointer;white-space:nowrap}
    button.secondary{background:#e8d6c6;color:#4b3a2c}
    button:disabled{opacity:.5;cursor:not-allowed}
    select, input[type="text"], input[type="number"], input[type="color"]{border:1px solid var(--border);border-radius:8px;padding:6px;background:#fffdf7; font-size:13px}
    .checkbox-label{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;user-select:none}
    label{font-size:12px;color:var(--muted);margin-bottom:2px;display:block}
    
    /* Slide Preview Area */
    .preview-area{
        overflow-x: auto;
        white-space: nowrap;
        padding: 10px 0;
        display: flex;
        gap: 16px;
        min-height: 480px;
        align-items: start;
        scrollbar-width: thin;
        scrollbar-color: var(--accent) var(--border);
    }
    .preview-area::-webkit-scrollbar { height: 8px; }
    .preview-area::-webkit-scrollbar-track { background: var(--border); border-radius: 4px; }
    .preview-area::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }

    /* Individual Slide */
    .slide-wrapper{display:inline-flex;flex-direction:column;gap:8px;vertical-align:top}
    .slide{
        width: 320px; /* Wider for better preview */
        aspect-ratio: 3/4;
        background: var(--slide-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        white-space: normal;
        display: flex;
        flex-direction: column;
        color: var(--slide-text);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        background-size: cover;
        background-position: center;
        transition: transform 0.2s;
    }
    .slide:hover{transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.15);}
    
    /* Slide Content Layers */
    .slide-bg{position:absolute;inset:0;z-index:0;background-size:cover;background-position:center;}
    .slide-overlay{position:absolute;inset:0;z-index:1;} /* Optional tint */
    .slide-content{
        position:relative;z-index:2;
        padding: 24px;
        flex:1;
        display:flex;
        flex-direction:column;
        overflow-y: hidden;
    }

    /* Typography inside slides */
    .slide-title{font-weight: 800; line-height: 1.3;}
    .slide-text{font-size: 18px; line-height: 1.6; font-weight: 500;}
    .slide-text ul { padding-left: 20px; margin: 0; }
    .slide-text li { margin-bottom: 8px; }
    .slide-text p { margin-bottom: 12px; }

    /* Cover Page Specifics */
    .slide.cover .slide-title { text-align: center; position: absolute; }
    
    /* Ending Page Specifics */
    .slide.ending .slide-content { padding: 0; }
    .ending-mask {
        position: absolute; inset: 0; z-index: 10;
        /* dynamic background set via JS */
        display: flex; align-items: flex-end; justify-content: center;
        padding-bottom: 60px;
    }
    .cta-box {
        color: white; text-align: center;
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(4px);
        padding: 8px 16px; border-radius: 99px;
        border: 1px solid rgba(255,255,255,0.4);
        font-size: 14px; font-weight: bold;
        position: absolute;
        /* Dynamic bottom position based on circle */
    }
    .circle-highlight {
        position: absolute; left: 50%; transform: translate(-50%, -50%);
        border-radius: 50%;
        pointer-events: none;
        /* Dynamic top/size */
    }

    /* Utilities */
    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none !important}
    .warning{color:#c83a3a;font-size:11px}
    .rel{position:relative}
    .control-group{border:1px solid var(--border); padding:8px; border-radius:8px; background:rgba(255,255,255,0.5)}
    .control-title{font-size:11px; font-weight:bold; color:var(--accent); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px}

    /* Global Overlay (Loading) */
    .overlay{position:absolute;inset:0;background:rgba(255,250,242,.9);border-radius:12px;display:flex;align-items:center;justify-content:center;gap:10px;flex-direction:column;z-index:20}
    .bar{height:8px;background:#efe4d6;border-radius:999px;overflow:hidden;border:1px solid var(--border);width:200px}
    .bar>div{height:100%;width:0;background:linear-gradient(90deg,#e3b18f,#c86a3a)}

    /* File Input Styling */
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RedNote Writer (Local AI)</h1>
    
    <!-- Top Controls: Global Settings & Customizations -->
    <div class="card" style="margin-bottom: 12px;">
      <div class="row" style="align-items:stretch">
        
        <!-- Images -->
        <div class="control-group col">
            <div class="control-title">Images</div>
            <div class="row">
                <div class="file-input-wrapper"><button class="secondary" style="font-size:12px">Up Cover</button><input type="file" id="coverUpload" accept="image/*"></div>
                <div class="file-input-wrapper"><button class="secondary" style="font-size:12px">Up Content</button><input type="file" id="bgUpload" accept="image/*"></div>
                <div class="file-input-wrapper"><button class="secondary" style="font-size:12px">Up End</button><input type="file" id="endUpload" accept="image/*"></div>
                <button id="resetImgs" class="secondary" style="font-size:12px">Reset</button>
            </div>
        </div>

        <!-- Cover Customization -->
        <div class="control-group col" style="flex:1">
            <div class="control-title">Cover Style</div>
            <div class="row">
                <div class="col" style="gap:4px">
                    <label>Title</label>
                    <input type="text" id="coverTitleInput" placeholder="Title..." style="width:80px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Font</label>
                    <select id="coverFontSelect" style="width:90px">
                        <option value="sans-serif">Sans Serif</option>
                        <option value="'PingFang SC', sans-serif">PingFang</option>
                        <option value="'Noto Sans CJK SC', sans-serif">Noto Sans</option>
                        <option value="'Songti SC', serif">Songti</option>
                        <option value="'Kaiti SC', cursive">Kaiti</option>
                    </select>
                </div>
                <div class="col" style="gap:4px">
                    <label>Size</label>
                    <input type="number" id="coverSize" value="36" style="width:40px">
                </div>
                <div class="col" style="gap:4px">
                    <label>X %</label>
                    <input type="number" id="coverX" value="50" style="width:40px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Y %</label>
                    <input type="number" id="coverY" value="50" style="width:40px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Rot °</label>
                    <input type="number" id="coverRot" value="0" style="width:40px">
                </div>
                 <div class="col" style="gap:4px">
                    <label>Color</label>
                    <input type="color" id="coverColor" value="#000000" style="width:30px;height:30px;padding:0;border:0">
                </div>
            </div>
        </div>

      </div>
      
      <div style="height:8px"></div>
      
      <div class="row" style="align-items:stretch">
        <!-- Content Page Customization -->
        <div class="control-group col" style="flex:1">
             <div class="control-title">Content Style</div>
             <div class="row">
                <div class="col" style="gap:4px">
                    <label>Pad</label>
                    <input type="number" id="contentPad" value="24" style="width:40px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Pad Color</label>
                    <input type="color" id="contentPadColor" value="#ffffff" style="width:30px;height:30px;padding:0;border:0">
                </div>
                <div class="col" style="gap:4px">
                    <label>Pad Opacity</label>
                    <input type="number" id="contentPadOp" value="0" min="0" max="1" step="0.1" style="width:40px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Text Color</label>
                    <input type="color" id="contentColor" value="#000000" style="width:30px;height:30px;padding:0;border:0">
                </div>
                <div class="col" style="gap:4px">
                    <label>Font</label>
                    <select id="contentFontSelect" style="width:90px">
                        <option value="sans-serif">Sans Serif</option>
                        <option value="'PingFang SC', sans-serif">PingFang</option>
                        <option value="'Songti SC', serif">Songti</option>
                    </select>
                </div>
             </div>
        </div>

        <!-- Ending Page Customization -->
        <div class="control-group col" style="flex:1">
             <div class="control-title">Ending Style</div>
             <div class="row">
                <div class="col" style="gap:4px">
                    <label>Circle Size</label>
                    <input type="number" id="endCircleSize" value="160" style="width:50px">
                </div>
                <div class="col" style="gap:4px">
                    <label>Circle Y%</label>
                    <input type="number" id="endCircleY" value="50" style="width:50px">
                </div>
             </div>
        </div>
      </div>

    </div>

    <!-- Output Preview (Slides) -->
    <div class="card rel" style="min-height: 480px;">
      <div class="preview-area" id="slideContainer">
        <!-- Slides will be injected here -->
        <div class="muted" style="margin:auto">Generated slides will appear here...</div>
      </div>

      <!-- Loading Overlay -->
      <div class="overlay" id="overlay">
        <div class="status" id="status">Initializing...</div>
        <div class="bar"><div id="progress"></div></div>
        <div class="muted" id="statusDetail"></div>
      </div>
    </div>

    <div style="height:12px"></div>

    <!-- Input Section -->
    <div class="card">
      <textarea id="input" placeholder="Paste content here..."></textarea>
      
      <div class="row">
        <button id="run" disabled>Rewrite</button>
        
        <label class="checkbox-label">
          <input type="checkbox" id="realtimeToggle"> 
          Real-time
        </label>
        <span class="warning hidden" id="rtWarning">High CPU</span>

        <div class="flex-spacer"></div>

        <span class="badge" id="modelTag">Model: Not Ready</span>
        <select id="modelSelect">
          <option value="small">Small</option>
          <option value="large">Large</option>
        </select>
        <button class="secondary hidden" id="loadLargeBtn">Load Large</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { CreateMLCEngine } from 'https://esm.run/@mlc-ai/web-llm';

    const $ = (id)=>document.getElementById(id);
    const input = $('input');
    const slideContainer = $('slideContainer');
    const status = $('status');
    const statusDetail = $('statusDetail');
    const runBtn = $('run');
    const modelTag = $('modelTag');
    const progress = $('progress');
    const overlay = $('overlay');
    const modelSelect = $('modelSelect');
    const loadLargeBtn = $('loadLargeBtn');
    const realtimeToggle = $('realtimeToggle');
    const rtWarning = $('rtWarning');
    
    // UI Controls
    const coverUpload = $('coverUpload');
    const bgUpload = $('bgUpload');
    const endUpload = $('endUpload');
    const resetImgs = $('resetImgs');
    
    // Cover Controls
    const coverTitleInput = $('coverTitleInput');
    const coverFontSelect = $('coverFontSelect');
    const coverSize = $('coverSize');
    const coverX = $('coverX');
    const coverY = $('coverY');
    const coverRot = $('coverRot');
    const coverColor = $('coverColor');

    // Content Controls
    const contentPad = $('contentPad');
    const contentPadColor = $('contentPadColor');
    const contentPadOp = $('contentPadOp');
    const contentColor = $('contentColor');
    const contentFontSelect = $('contentFontSelect');

    // Ending Controls
    const endCircleSize = $('endCircleSize');
    const endCircleY = $('endCircleY');

    // State
    const state = {
        coverImg: null,
        contentBg: null,
        endImg: null,
        coverTitle: 'RedNote Title',
        coverFont: 'sans-serif',
        coverSize: 36,
        coverX: 50,
        coverY: 50,
        coverRot: 0,
        coverColor: '#000000',
        
        contentPad: 24,
        contentPadColor: '#ffffff',
        contentPadOp: 0,
        contentColor: '#000000',
        contentFont: 'sans-serif',

        endCircleSize: 160,
        endCircleY: 50,

        generatedText: '',
        slides: [] 
    };

    // Models
    const SMALL_MODEL = 'Qwen2-0.5B-Instruct-q4f16_1-MLC';
    const LARGE_MODEL = 'Phi-3.5-mini-instruct-q4f16_1-MLC';
    let engine;
    let currentModelId = SMALL_MODEL;
    let isSmallLoaded = false;
    let isLargeLoaded = false;
    let isGenerating = false;
    let debounceTimer = null;
    let lastRunTime = 0;

    // --- UI Listeners ---

    function bind(el, key, type='value'){
        el.addEventListener('input', (e)=>{
            state[key] = type==='number'? parseFloat(e.target.value) : e.target.value;
            renderSlides();
        });
    }
    
    // Bind all controls
    bind(coverTitleInput, 'coverTitle');
    bind(coverFontSelect, 'coverFont');
    bind(coverSize, 'coverSize', 'number');
    bind(coverX, 'coverX', 'number');
    bind(coverY, 'coverY', 'number');
    bind(coverRot, 'coverRot', 'number');
    bind(coverColor, 'coverColor');
    
    bind(contentPad, 'contentPad', 'number');
    bind(contentPadColor, 'contentPadColor');
    bind(contentPadOp, 'contentPadOp', 'number');
    bind(contentColor, 'contentColor');
    bind(contentFontSelect, 'contentFont');

    bind(endCircleSize, 'endCircleSize', 'number');
    bind(endCircleY, 'endCircleY', 'number');

    // Image Handling
    function handleImageUpload(e, key){
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            state[key] = evt.target.result;
            renderSlides();
        };
        reader.readAsDataURL(file);
    }
    coverUpload.addEventListener('change', (e)=>handleImageUpload(e, 'coverImg'));
    bgUpload.addEventListener('change', (e)=>handleImageUpload(e, 'contentBg'));
    endUpload.addEventListener('change', (e)=>handleImageUpload(e, 'endImg'));
    
    resetImgs.addEventListener('click', ()=>{
        state.coverImg = null;
        state.contentBg = null;
        state.endImg = null;
        renderSlides();
    });

    // --- Slide Rendering ---
    
    function renderSlides(){
        slideContainer.innerHTML = '';
        
        // 1. Cover Slide
        const coverWrapper = createSlideWrapper('Cover');
        const coverSlide = createSlideElement();
        if(state.coverImg) setSlideBg(coverSlide, state.coverImg);
        else coverSlide.style.background = '#e8d6c6';
        
        const coverContent = document.createElement('div');
        coverContent.className = 'slide-content';
        
        // Dynamic Title
        const titleEl = document.createElement('div');
        titleEl.className = 'slide-title';
        titleEl.style.fontFamily = state.coverFont;
        titleEl.textContent = state.coverTitle;
        titleEl.style.fontSize = `${state.coverSize}px`;
        titleEl.style.color = state.coverColor;
        titleEl.style.position = 'absolute';
        titleEl.style.left = `${state.coverX}%`;
        titleEl.style.top = `${state.coverY}%`;
        titleEl.style.transform = `translate(-50%, -50%) rotate(${state.coverRot}deg)`;
        titleEl.style.width = '100%'; // Ensure centering works relative to slide width
        titleEl.style.textAlign = 'center';
        titleEl.style.pointerEvents = 'none'; // Click through

        coverContent.appendChild(titleEl);
        coverSlide.appendChild(coverContent);
        coverWrapper.appendChild(coverSlide);
        slideContainer.appendChild(coverWrapper);

        // 2. Content Slides
        const chunks = state.slides.length ? state.slides : (state.generatedText ? splitContentToSlides(state.generatedText) : []);
        // Force at least one empty slide if nothing exists
        const renderChunks = chunks.length ? chunks : [];

        renderChunks.forEach((text, idx) => {
            const wrapper = createSlideWrapper(`Page ${idx+1}`);
            const slide = createSlideElement();
            if(state.contentBg) setSlideBg(slide, state.contentBg);
            
            const content = document.createElement('div');
            content.className = 'slide-content';
            content.style.padding = `${state.contentPad}px`;
            
            // Padding Background (Frame/Border effect)
            if(state.contentPadOp > 0){
                 const padBg = document.createElement('div');
                 padBg.style.position = 'absolute';
                 padBg.style.inset = '0'; // Cover entire slide
                 padBg.style.border = `${state.contentPad}px solid ${state.contentPadColor}`;
                 padBg.style.background = 'transparent'; // Center is clear
                 padBg.style.opacity = state.contentPadOp;
                 padBg.style.zIndex = 1; // On top of bg, below text? No, text is z-index 2.
                 // We need this to be below text but above bg.
                 // content is z-index 2.
                 // This padBg is appended to content.
                 // So it will be inside content.
                 // content has padding.
                 // If content has padding, and padBg is absolute inset 0 relative to content...
                 // content width = 100%.
                 // padBg will cover the content area.
                 // We want padBg to cover the SLIDE.
                 // Append padBg to SLIDE, not CONTENT.
                 // slide is relative.
                 padBg.style.zIndex = 1; 
                 padBg.style.pointerEvents = 'none';
                 padBg.style.boxSizing = 'border-box';
                 
                 // Note: "content" has z-index 2. We want padBg to be visible.
                 // If padBg is z-index 1, it's under content.
                 // Content has text. Text is what we see.
                 // The "padding area" of content is empty space.
                 // So z-index 1 is fine.
                 slide.appendChild(padBg);
            }

            const textEl = document.createElement('div');
            textEl.className = 'slide-text';
            textEl.style.color = state.contentColor;
            textEl.style.fontFamily = state.contentFont;
            textEl.innerHTML = parseMarkdown(text); 
            content.appendChild(textEl);
            slide.appendChild(content);
            wrapper.appendChild(slide);
            slideContainer.appendChild(wrapper);
        });

        // 3. Ending Slide
        const endWrapper = createSlideWrapper('Ending');
        const endSlide = createSlideElement();
        endSlide.classList.add('ending');
        if(state.endImg) setSlideBg(endSlide, state.endImg);
        else endSlide.style.background = '#333';
        
        // Mask Overlay
        const mask = document.createElement('div');
        mask.className = 'ending-mask';
        
        // Calculate circle and mask
        // Using radial gradient to create "hole"
        // center at 50% state.endCircleY%
        const cy = state.endCircleY;
        const r = state.endCircleSize / 2;
        // We need pixel value for radial-gradient if we want exact pixels?
        // Or we can use `transparent r, black r+1`.
        // The center position is percentage.
        // BUT the slide height is fixed in CSS preview as aspect-ratio.
        // We can approximate or use exact calculation if we assume slide is 320px wide -> height = 320 * 4/3 = 426px.
        // Let's use `radial-gradient(circle at 50% ${cy}%, transparent ${r}px, rgba(0,0,0,0.9) ${r+1}px)`
        
        mask.style.background = `radial-gradient(circle at 50% ${cy}%, transparent ${r}px, rgba(0,0,0,0.9) ${r+1}px)`;
        
        const circle = document.createElement('div');
        circle.className = 'circle-highlight';
        circle.style.width = `${state.endCircleSize}px`;
        circle.style.height = `${state.endCircleSize}px`;
        circle.style.top = `${cy}%`;

        const cta = document.createElement('div');
        cta.className = 'cta-box';
        cta.textContent = "Follow for more updates ✓";
        // Position CTA below circle.
        // Circle bottom is cy% + r px.
        // We can just put it at bottom of mask with padding, or relative to circle.
        // User said "CTA below circle adjust together".
        // Let's calculate top position for CTA.
        // Top = cy% + r + 20px (gap)
        cta.style.position = 'absolute';
        cta.style.top = `calc(${cy}% + ${r}px + 20px)`;
        cta.style.left = '50%';
        cta.style.transform = 'translateX(-50%)';

        mask.appendChild(circle);
        mask.appendChild(cta);

        endSlide.appendChild(mask);
        endWrapper.appendChild(endSlide);
        slideContainer.appendChild(endWrapper);
    }

    function createSlideWrapper(label){
        const w = document.createElement('div');
        w.className = 'slide-wrapper';
        const l = document.createElement('div');
        l.className = 'muted';
        l.style.textAlign='center';
        l.textContent = label;
        w.appendChild(l);
        return w;
    }

    function createSlideElement(){
        const s = document.createElement('div');
        s.className = 'slide';
        return s;
    }

    function setSlideBg(el, src){
        const bg = document.createElement('div');
        bg.className = 'slide-bg';
        bg.style.backgroundImage = `url(${src})`;
        el.appendChild(bg);
        const ov = document.createElement('div');
        ov.className = 'slide-overlay';
        el.appendChild(ov);
    }

    function parseMarkdown(text){
        if(!text) return '';
        // Basic parser
        let html = text
            .replace(/^# (.*$)/gim, '<strong>$1</strong>')
            .replace(/^## (.*$)/gim, '<strong>$1</strong>')
            .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
            .replace(/\n/gim, '<br>');
        return html;
    }

    // --- Content Splitting Logic ---
    function splitContentToSlides(fullText){
        if(!fullText) return [];
        
        // Improved splitting for mobile-focused slides (RedNote style)
        // Split by lines to ensure granular control
        const lines = fullText.split(/\n/);
        const slides = [];
        let current = "";
        const CHAR_LIMIT = 120; // Aggressive limit for big text/mobile view
        
        for(let line of lines){
            // If adding this line exceeds limit, push current and start new
            // But if current is empty, just take the line (even if huge)
            if(current.length > 0 && (current.length + line.length > CHAR_LIMIT)){
                 slides.push(current.trim());
                 current = line;
            } else {
                 // Preserve original spacing
                 current += (current ? "\n" : "") + line;
            }
        }
        if(current) slides.push(current.trim());
        
        return slides;
    }

    // --- Model Logic ---
    function setStatus(t, detail=''){ 
        status.textContent = t; 
        if(detail) statusDetail.textContent = detail;
    }
    function setProgress(p){ progress.style.width = Math.max(0,Math.min(100,Math.round(p*100)))+'%' }
    function showOverlay(show){ overlay.style.display = show ? 'flex' : 'none'; }

    async function loadModel(which){
      const targetModel = which === 'large' ? LARGE_MODEL : SMALL_MODEL;
      showOverlay(true);
      runBtn.disabled = true;
      setStatus(`Loading ${which}...`, 'Please wait...');
      setProgress(0);
      try{
        engine = await CreateMLCEngine(targetModel,{
          initProgressCallback:(p)=>{
            setStatus(`Loading... ${Math.round(p.progress*100)}%`, p.text||'');
            setProgress(p.progress);
          }
        });
        currentModelId = targetModel;
        if(which === 'small') isSmallLoaded = true;
        if(which === 'large') isLargeLoaded = true;
        modelTag.textContent = `Model: ${which === 'large' ? 'Large' : 'Small'}`;
        showOverlay(false);
        runBtn.disabled = false;
        updateControls();
      }catch(e){
        console.error(e);
        setStatus('Load Failed', e.message);
      }
    }

    function updateControls(){
        const selected = modelSelect.value;
        if(selected === 'large' && currentModelId !== LARGE_MODEL){
            loadLargeBtn.classList.remove('hidden');
            loadLargeBtn.textContent = isLargeLoaded ? "Switch to Large" : "Load Large";
            runBtn.disabled = true;
            modelTag.textContent = isLargeLoaded ? "Paused" : "Not Loaded";
        } else {
            loadLargeBtn.classList.add('hidden');
            if(selected === 'large'){
                runBtn.disabled = false;
                modelTag.textContent = "Model: Large";
            } else {
                if(currentModelId === SMALL_MODEL){
                    runBtn.disabled = false;
                    modelTag.textContent = "Model: Small";
                } else {
                     runBtn.disabled = true;
                }
            }
        }
    }

    modelSelect.addEventListener('change', async () => {
        if(modelSelect.value === 'large') updateControls(); 
        else {
            if(currentModelId !== SMALL_MODEL) await loadModel('small');
            updateControls();
        }
    });
    loadLargeBtn.addEventListener('click', () => loadModel('large'));

    // --- Realtime & Run ---
    function triggerRealtime() {
        if(!realtimeToggle.checked) return;
        const now = Date.now();
        clearTimeout(debounceTimer);
        if(lastRunTime > 0 && (now - lastRunTime > 10000)){
             run();
        } else {
             debounceTimer = setTimeout(run, 3000);
        }
    }

    realtimeToggle.addEventListener('change', () => {
        const on = realtimeToggle.checked;
        rtWarning.classList.toggle('hidden', !on);
        if(!on) clearTimeout(debounceTimer);
        else if(input.value.trim()) triggerRealtime();
    });
    input.addEventListener('input', triggerRealtime);

    function buildPrompt(userText){
      const len = userText.length;
      const base = `You are a RedNote content editor. Task: "Format optimization or summary". Do not expand, fabricate, or add new info. Output in the same language as input. Layout: Subtitles ([] or #), short sentences, bullets (• or -), moderate emojis.`;
      if(len<40) return `${base}\nRule: Short text. Light formatting. ≤60 words.\n\nText:\n${userText}`;
      if(len>3000) return `${base}\nRule: Long text. Summarize to ≤200 words. Bullet points.\n\nText:\n${userText}`;
      return `${base}\nRule: Rewrite into clear short sentences. 2-4 sections. Add key points.\n\nText:\n${userText}`;
    }

    async function run(){
      if(isGenerating) return;
      const text = input.value.trim();
      if(!text) return;
      
      isGenerating = true;
      runBtn.disabled=true; 
      
      state.generatedText = '';
      state.slides = [];
      
      showOverlay(true);
      setStatus('Generating...');
      setProgress(1); 
      progress.parentElement.style.display = 'none';

      lastRunTime = Date.now();
      const messages=[{role:'system',content:'You are a high-quality social media content editor.'},{role:'user',content:buildPrompt(text)}];
      
      try{
        const stream=await engine.chat.completions.create({messages,temperature:0.4,stream:true,max_tokens:600});
        showOverlay(false);
        
        let fullAcc = "";
        for await(const chunk of stream){
          const token=chunk.choices?.[0]?.delta?.content||'';
          fullAcc += token;
          state.generatedText = fullAcc;
          // Live rendering every 50 chars to avoid flicker
          if(fullAcc.length % 50 === 0) {
             state.slides = splitContentToSlides(fullAcc);
             renderSlides();
          }
        }
        state.slides = splitContentToSlides(state.generatedText);
        renderSlides();
      }catch(e){ 
        console.error(e); 
        showOverlay(true);
        setStatus('Failed', e.message);
        setTimeout(()=>showOverlay(false), 3000);
      }finally{ 
        isGenerating = false;
        runBtn.disabled=false; 
        progress.parentElement.style.display = 'block'; 
        updateControls(); 
      }
    }

    runBtn.addEventListener('click',run);
    
    // Initial Render
    renderSlides();
    loadModel('small');
  </script>
</body>
</html>
